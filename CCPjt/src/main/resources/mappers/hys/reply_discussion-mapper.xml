<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="Reply_Discussion">


	<!-- 댓글 리스트 불러오기 -->
	<select id="getDiscussionReplyList" resultType="ReplyVo_Discussion">
		select * 
	    from(select rownum rnum, a.*, (select count(*) from discussion_reply where b_serialno = #{b_serialno}) totalReplyCount
	        from ( select * 
	        	   from discussion_reply
	        	   where b_serialno = #{b_serialno}
	               order by r_no desc) a)
	    where rnum &gt;= #{startRow} and rnum &lt;= #{endRow}
	</select>
	
	<select id="getReplyCount" resultType="int">
		select count(*) from discussion_reply
		where b_serialno = #{b_serialno}
	</select>
	
	<!-- 댓글 쓰기 -->
	<insert id="writeReply">
		insert into discussion_reply(b_serialno, r_no, r_writer , r_content ,r_yesorno)
        values (#{b_serialno}, seq_discussion_reply.nextval, #{r_writer}, #{r_content}, #{r_yesOrNo})
	</insert>
	
	<!-- 댓글에 대해 좋아요 또는 싫어요값 추가 -->
	<insert id="replylikeInfoAdd">
		insert into discussion_reply_likeInfo (u_id, r_no, r_up , r_down)
		values (#{u_id},#{r_no},#{r_up},#{r_down})
	</insert>
	
	<!-- 댓글에 대해 좋아요 또는 싫어요 총 값 갱신-->
	<update id="replyLikeCountModify">
		update discussion_reply 
		set r_upcount = (select count(*) from discussion_reply_likeinfo
        				where r_no =#{r_no} and r_up =1),
        	r_downcount = (select count(*) from discussion_reply_likeinfo
        				where r_no =#{r_no} and r_down =1)
       where r_no = #{r_no} 			
	</update>
	
	<!-- 특정 댓글에 관하여 좋아여 싫어요 했는지 판단 0 = 안함  1 = 함-->
	<select id="replyLikeInfoExist" resultType="int">
		select count(*)
        from discussion_reply_likeinfo
        where r_no = #{r_no} and u_id = #{u_id}
	</select>
	
	<!-- 이미 좋아요 또는 싫어요를 눌렀다면 새로 업데이트 -->
	<update id="replyLikeInfoModify">
		update discussion_reply_likeinfo
		set r_up = r_up + #{r_up},
			r_down =  r_down + #{r_down}
		where r_no = #{r_no} and u_id = #{u_id}
	</update>
	
	<!-- 좋아요 싫어요  버튼 취소 기능 -->
	<update id="replyLikeInfoCancel">
        update (select r_up, r_down, r_up+r_down from discussion_reply_likeinfo where  r_up+r_down >= 2)
        set r_up = 0 , r_down = 0
	</update>
	
	<!-- 특정유저가 좋아요or싫어요 표시한 정보 가져오기 -->
	<select id="replyLikeInfoById" resultType="ReplyLikeInfoDto_Discussion">
	    select * from discussion_reply_likeinfo
        where u_id = #{u_id}
	</select>

</mapper>